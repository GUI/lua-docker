# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY. Edit /Dockerfile.erb and run /update instead.

FROM <%= distro %>:<%= distro_version %>

RUN set -ex \
  <% if distro == "debian" || distro == "ubuntu" -%>
    && saved_apt_mark="$(apt-mark showmanual)" \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
      ca-certificates \
      curl \
      gcc \
      libc6-dev \
      make \
      <% if lang == "lua" -%>
        libreadline-dev \
        <% if version_minor == "5.1" -%>
          libncurses-dev \
        <% end -%>
      <% end -%>
      <% if variant.include?("luarocks") -%>
        dirmngr \
        gnupg \
        unzip \
      <% end -%>
  <% elsif distro == "alpine" -%>
    && apk add --no-cache --virtual .lua-builddeps \
      ca-certificates \
      curl \
      gcc \
      libc-dev \
      make \
      <% if lang == "lua" -%>
        readline-dev \
        <% if version_minor == "5.1" -%>
          ncurses-dev \
        <% end -%>
      <% end -%>
      <% if variant.include?("luarocks") -%>
        coreutils \
        gnupg \
        unzip \
      <% end -%>
  <% elsif distro == "centos" -%>
    && yum -y install \
      ca-certificates \
      curl \
      gcc \
      glibc-devel \
      make \
      <% if lang == "lua" -%>
        readline-devel \
        <% if version_minor == "5.1" -%>
          ncurses-devel \
        <% end -%>
      <% end -%>
      <% if variant.include?("luarocks") -%>
        dirmngr \
        gnupg2 \
        unzip \
      <% end -%>
  <% end -%>
  && curl -fsSL -o /tmp/lua.tar.gz "<%= archive_url %>" \
  && cd /tmp \
  && echo "<%= archive_md5 %> *lua.tar.gz" | md5sum -c - \
  && mkdir /tmp/lua \
  && tar -xf /tmp/lua.tar.gz -C /tmp/lua --strip-components=1 \
  && cd /tmp/lua \
  <% if lang == "luajit" && variant.include?("lua52compat") -%>
    && make CFLAGS="-DLUAJIT_ENABLE_LUA52COMPAT" \
  <% elsif lang == "luajit" || version_minor == "5.0" -%>
    && make \
  <% else -%>
    && make linux \
  <% end -%>
  && make install \
  <% if lang == "luajit" && version.prerelease? -%>
    && ln -s /usr/local/bin/luajit-<%= version_full %> /usr/local/bin/luajit \
  <% end -%>
  <% if variant.include?("luarocks") -%>
    && curl -fsSL -o /tmp/luarocks.tar.gz "https://luarocks.org/releases/luarocks-<%= luarocks_version %>.tar.gz" \
    && curl -fsSL -o /tmp/luarocks.tar.gz.asc "https://luarocks.org/releases/luarocks-<%= luarocks_version %>.tar.gz.asc" \
    && cd /tmp \
    && export GNUPGHOME="$(mktemp -d)" \
    && export GPG_KEYS="8460980B2B79786DE0C7FCC83FD8F43C2BB3C478" \
    && (gpg --batch --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-keys "$GPG_KEYS" || gpg --batch --keyserver hkp://ipv4.pool.sks-keyservers.net:80 --recv-keys "$GPG_KEYS" || gpg --batch --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys "$GPG_KEYS" || gpg --batch --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys "$GPG_KEYS") \
    && gpg --batch --verify luarocks.tar.gz.asc luarocks.tar.gz \
    && rm -rf "$GNUPGHOME" \
    && mkdir /tmp/luarocks \
    && tar -xf /tmp/luarocks.tar.gz -C /tmp/luarocks --strip-components=1 \
    && cd /tmp/luarocks \
    && ./configure \
    && make \
    && make install \
  <% end -%>
  && cd / \
  <% if distro == "debian" || distro == "ubuntu" -%>
    && apt-mark auto '.*' > /dev/null \
    && apt-mark manual $saved_apt_mark \
    <% if lang == "lua" -%>
      && dpkg-query --show --showformat '${package}\n' | grep -P '^libreadline\d+$' | xargs apt-mark manual \
      <% if version_minor == "5.1" -%>
        && dpkg-query --show --showformat '${package}\n' | grep -P '^libncurses\d+$' | xargs apt-mark manual \
      <% end -%>
    <% end -%>
    <% if variant.include?("luarocks") -%>
      && apt-mark manual \
        ca-certificates \
        curl \
        unzip \
    <% end -%>
    && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
    && rm -rf /var/lib/apt/lists/* \
  <% elsif distro == "alpine" -%>
    && apk add --no-network --no-cache --virtual .lua-rundeps \
      <% if lang == "lua" -%>
        readline \
        <% if version_minor == "5.1" -%>
          ncurses-libs \
        <% end -%>
      <% end -%>
      <% if lang == "luajit" -%>
        libgcc \
      <% end -%>
      <% if variant.include?("luarocks") -%>
        ca-certificates \
        coreutils \
        curl \
        unzip \
      <% end -%>
    && apk del --no-network .lua-builddeps \
  <% elsif distro == "centos" -%>
    && yum -y history undo last \
    <% if lang == "lua" -%>
      && yum -y install readline \
      <% if version_minor == "5.1" -%>
        && yum -y install ncurses \
      <% end -%>
    <% end -%>
    <% if variant.include?("luarocks") -%>
      && yum -y install \
        ca-certificates \
        curl \
        unzip \
    <% end -%>
    && yum clean all \
    && rm -rf /var/cache/yum \
  <% end -%>
  && rm -rf /tmp/lua /tmp/lua.tar.gz \
  <% if variant.include?("luarocks") -%>
    && rm -rf /tmp/luarocks /tmp/luarocks.tar.gz \
    && luarocks --version \
  <% end -%>
  && <%= lang %> -v

CMD ["<%= lang %>"]
